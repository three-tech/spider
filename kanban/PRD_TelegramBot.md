# 产品需求文档 (PRD): Telegram 内容推送机器人

| 版本 | 日期       | 作者 | 变更说明 |
| :--- | :--------- | :--- | :------- |
| 1.0  | 2025-09-30 | AI架构师 | 初稿创建 |

---

## 1. 背景与问题陈述

### 1.1 问题陈述
当前，我们从 `ResourceX` 表中获取到的高质量图片和视频内容，依赖人工手动分发到不同的Telegram社群中。这个过程不仅效率低下、耗时耗力，而且容易出错，无法规模化运营。我们缺乏一个自动化的系统来根据内容标签精准地推送给目标受众，也缺少有效的工具来监控分发状态、管理社群互动以及实现商业化（如广告）。

### 1.2 目标
为了解决以上问题，我们计划开发一个 **Telegram 内容推送机器人**。该机器人旨在实现以下核心目标：
- **自动化内容分发**：自动、准时、准确地将内容推送到指定的Telegram群组。
- **提升运营效率**：将管理员从重复的手动劳动中解放出来，专注于内容策略和社群运营。
- **精细化管理**：提供强大的后台管理能力，包括任务控制、数据监控、广告投放等。
- **增强社群活跃度**：通过稳定、高质量的内容供给，提升社群成员的活跃度和粘性。

## 2. 用户故事

**核心用户角色**: **管理员 (Admin)**

- **故事1 (内容路由)**: 作为一名管理员，我希望可以预设规则，将不同`tag`的内容自动发送到指定的Telegram群组，这样我就可以为不同的兴趣社群提供精准的内容，实现精细化运营。

- **故事2 (状态监控)**: 作为一名管理员，我希望能随时了解机器人的运行状态，包括每个群的成员数量、待推送的资源剩余量，并在出现异常（如发送失败）时立即收到警报，以便我能快速响应和处理问题。

- **故事3 (手动干预)**: 作为一名管理员，我希望能通过简单的指令，让机器人立即对单个或所有群组进行一次内容重推，以应对临时的运营需求或弥补之前的发送失败。

- **故事4 (广告管理)**: 作为一名管理员，我希望能方便地管理广告内容，并灵活配置广告在不同群组的投放策略（例如，在每次推送N条内容后附带一则广告，或在每天的固定时间推送），从而探索商业化变现的可能性。

- **故事5 (任务控制)**: 作为一名管理员，我需要能够随时启动、暂停或进行一次测试运行内容推送任务，以确保在系统维护或调试期间，我拥有对机器人行为的完全控制权。

## 3. 解决方案概述

我们将创建一个名为 `telegram` 的新Python模块。该模块的核心是一个功能强大的Telegram机器人，它将具备以下能力：

1.  **数据库交互**: 定期从 `ResourceX` 数据库表中读取待推送的视频和图片资源。
2.  **任务调度器**: 内置一个健壮的定时任务系统（如 APScheduler），用于执行周期性的内容推送和广告发送。
3.  **配置中心**: **采用数据库驱动的配置模式**。所有动态配置项（如管理员ID、广告群ID、标签路由规则等）将从数据库中读取。这将允许管理员在不重启服务的情况下动态更新配置。核心的数据库连接信息和Bot Token等启动所必需的静态配置，仍保留在通用的 `base.config` 模块中。
4.  **指令解析器**: 机器人能够识别并执行来自授权管理员的特定指令（如 `/summary`, `/repush_all`）。
5.  **智能推送引擎**:
    -   根据配置，将内容分发到正确的群组。
    -   根据配置，在内容流中智能插入广告。
    -   记录已推送的内容，避免重复发送。
6.  **监控与警报**: **全面集成项目通用的 `base.logger` 模块进行结构化日志记录。** 在任务失败或出现关键错误时，除了记录日志，还会通过Telegram消息主动通知管理员。

## 4. 功能需求详述

### 4.1 F1: 核心推送功能
- **4.1.2 订阅与进度跟踪**: 引入一张核心的 `telegram_subscriptions` 表，用于统一管理“订阅关系”和“推送进度”。
    -   **表结构**: 至少包含 `chat_id` (群组ID), `tag` (订阅的标签), `last_resource_x_id` (该标签在该群组的最后推送ID), `is_active` (是否启用)。
    -   **复合主键**: `(chat_id, tag)`。
- **4.1.3 内容获取 (按订阅)**: 推送任务将遍历 `telegram_subscriptions` 表中的每一条有效订阅。对于每一条订阅记录，任务会根据其 `tag` 和 `last_resource_x_id`，从 `ResourceX` 表中查询 `id > last_resource_x_id` 的下一条匹配资源。
- **4.1.4 状态更新 (按订阅)**: 内容成功推送到目标群组后，系统将更新 `telegram_subscriptions` 表中**对应订阅记录**的 `last_resource_x_id` 字段为刚刚发送的资源ID。这确保了每个群组的每个标签都有自己独立的、精确的消费位点。
- **4.1.5 媒体发送机制**: 机器人将直接利用Telegram API的功能，通过媒体文件的URL进行发送。具体流程为：从数据库获取图片/视频URL后，调用相应的`send_photo`或`send_video`接口，并将URL作为参数传递。Telegram服务器将负责从源URL下载文件并推送到目标群组。此方法无需本地下载和中转，高效且节省资源。发送时将附带推文内容作为`caption`。

### 4.2 F2: 监控与汇报
- **4.2.1 数据汇总 (指令)**:
    -   **指令**: `/summary`
    -   **功能**: 机器人收到指令后，回复一条汇总信息，包括：
        -   已配置的群组总数。
        -   每个群组的当前成员数。
        -   `ResourceX`表中待推送的资源总数。
- **4.2.2 异常报警**:
    -   **触发条件**: API请求失败、数据库连接断开、配置读取错误等关键异常。
    -   **行为**: 立即向数据库中配置的“管理员频道”发送一条包含错误信息的警报。
- **4.2.3 自动任务报告**:
    -   **触发条件**: 每轮定时推送任务（包括内容推送和广告推送）全部执行完毕后。
    -   **行为**: 自动调用数据汇总功能，并将生成的报告发送给所有在数据库中配置的管理员。报告内容可包含本轮推送的内容条数、覆盖的群组数、成功/失败次数等关键绩效指标（KPI）。

### 4.3 F3: 管理员指令
- **4.3.1 权限控制**: 只有在数据库中配置的管理员`user_id`才能执行管理指令。**为保证最高级别的安全性，管理员的添加与删除必须通过后台直接操作数据库完成，机器人不提供相关指令。**
- **4.3.2 单群重推 (指令)**:
    -   **指令**: `/repush_group [chat_id]`
    -   **功能**: 获取指定群组最近一次推送的内容，并重新发送一次。
- **4.3.3 全局重推 (指令)**:
    -   **指令**: `/repush_all`
    -   **功能**: 为所有已配置的群组触发一次重推任务。

### 4.4 F4: 广告管理系统
- **4.4.1 广告入库 (转发机制)**:
    -   **流程**:
        1.  设立一个私有的“广告素材群”。
        2.  广告主在该群内发布广告素材（文本、图片、视频）。
        3.  管理员审核后，将合格的广告消息直接【转发】给机器人。
    -   **功能**: 机器人会自动识别出来自指定“广告素材群”的转发消息。一旦收到此类消息，机器人会将其完整内容（包括文本、媒体和格式）保存到广告库中，并为其分配一个唯一的广告ID。
    -   **配置**: “广告素材群”的`chat_id`需要在数据库中进行配置。
- **4.4.2 广告策略配置 (指令)**:
    -   **指令**: `/config_ad [ad_id] [chat_id] [strategy]`
    -   **功能**: 为特定广告配置投放策略。策略格式示例：
        -   `after:5`: 每推送5条内容后，发送一次该广告。
        -   `cron:0 20 * * *`: 每天晚上8点定时发送。
- **4.4.3 广告投放**: 推送主任务在执行时，会检查并根据策略投放广告。

### 4.5 F5: 任务生命周期管理
- **4.5.1 任务启停 (指令)**:
    -   **指令**: `/start_job`, `/stop_job`
    -   **功能**: 启动或平滑停止主内容推送的定时任务。
- **4.5.2 任务试跑 (指令)**:
    -   **指令**: `/test_run [chat_id]`
    -   **功能**: 从数据库中随机获取一条未推送内容，立即发送到指定群组进行测试，但不更新其在数据库中的“已推送”状态。

## 5. 验收标准

- **AC1 (内容路由)**: 在`ResourceX`表中插入一条带`news`标签的视频，机器人能在下一个任务周期内，准确地将其发送到所有配置了接收`news`标签的群组，并且数据库状态被更新。
- **AC2 (监控汇报)**: 管理员发送`/summary`指令，机器人能在5秒内回复格式正确、数据非零的统计信息。模拟一次API发送失败，管理员能在1分钟内收到包含失败原因的警报。
- **AC3 (手动干预)**: 管理员执行`/repush_group`指令后，目标群组能立即收到一条重复内容。
- **AC4 (广告投放)**: 配置一条广告为`after:2`策略，在机器人推送第2、4、6...条内容后，该广告被准确地发送到目标群组。
- **AC5 (任务控制)**: 执行`/stop_job`后，定时推送停止；再次执行`/start_job`后，推送恢复。执行`/test_run`后，目标群组收到测试内容，但该内容在数据库中的状态仍为“未推送”。

## 6. 成功指标

- **效率提升**: 管理员每周花在手动内容分发上的时间减少95%以上。
- **系统可靠性**: 自动内容推送成功率 > 99.8%。
- **社群增长**: 接入机器人的群组，在3个月内平均成员增长率提升15%。
- **功能采用率**: 核心功能（如广告管理、数据汇总）在上线后1个月内被管理员使用超过10次。

---

## 附录A: 数据模型 (初步设计)

根据最新的设计决策，我们将采用一个高度灵活的、类似实体-属性-值（EAV）的简化模型来存储所有动态配置。

### `telegram_settings`
存储机器人的所有可动态配置的实体，如管理员、广告、策略等。每个实体是一行。

| 字段名      | 类型          | 主键 | 索引 | 说明                               |
| :---------- | :------------ | :--- | :--- | :--------------------------------- |
| `id`        | INT           | ✅   |      | 唯一自增ID                         |
| `type`      | VARCHAR(255)  |      | ✅   | 实体的类型 (e.g., `admin`, `ad`, `ad_strategy`) |
| `config`    | JSON          |      |      | 存储实体具体内容的JSON对象         |
| `description` | TEXT          |      |      | 对该配置项的描述                   |
| `updated_at`| DATETIME      |      |      | 最后更新时间                       |

**设计说明**:
- `type` 字段用于分类。当应用需要获取所有管理员时，会执行 `SELECT config FROM telegram_settings WHERE type = 'admin'`，这将返回一个JSON对象列表。
- `key` 字段被重命名为 `type` 以更准确地反映其作为“类型标识”的职责。
- 主键不再是业务字段，而是一个简单的自增ID，允许`type`字段重复。

**示例数据**:

1.  **全局设置** (`type` = `global_setting`):
    -   `type`: `global_setting`, `config`: `{"name": "ad_group_id", "value": "-100123456789"}`
    -   `type`: `global_setting`, `config`: `{"name": "alert_channel_id", "value": "-100987654321"}`

2.  **管理员** (`type` = `admin`):
    -   `type`: `admin`, `config`: `{"user_id": 12345678, "username": "admin_one"}`
    -   `type`: `admin`, `config`: `{"user_id": 87654321, "username": "admin_two"}`

3.  **广告素材** (`type` = `ad`):
    -   `type`: `ad`, `config`: `{"ad_id": 1, "message_data": {"...": "..."}, "creator_id": 12345678}`
    -   `type`: `ad`, `config`: `{"ad_id": 2, "message_data": {"...": "..."}, "creator_id": 87654321}`

4.  **广告策略** (`type` = `ad_strategy`):
    -   `type`: `ad_strategy`, `config`: `{"ad_id": 1, "chat_id": -100123, "type": "after_count", "value": "5"}`
    -   `type`: `ad_strategy`, `config`: `{"ad_id": 2, "chat_id": -100456, "type": "cron", "value": "0 20 * * *"}`


### `telegram_subscriptions`
核心表，管理群组的标签订阅关系及推送进度。 (此表结构保持不变)

| 字段名               | 类型         | 主键 | 说明                                                         |
| :------------------- | :----------- | :--- | :----------------------------------------------------------- |
| `id`        | INT           | ✅   |      | 唯一自增ID                         |
| `chat_id`            | BIGINT       |    | 目标群组的Telegram Chat ID                                   |
| `tag`                | VARCHAR(255) |    | 订阅的内容标签                                               |
| `last_resource_x_id` | BIGINT       |      | 对于此订阅，从`ResourceX`表推送的最后一条内容的ID。默认为0。 |
| `is_active`          | BOOLEAN      |      | 是否启用此条订阅规则，默认为`true`。                         |
| `created_at`         | DATETIME     |      | 创建时间                                                     |
| `updated_at`         | DATETIME     |      | 最后更新时间                                                 |